<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OncologyML Dashboard</title>
    <style>
        :root {
            --primary: #1a56db; --accent: #10b981; --bg: #f1f5f9;
            --card: #fff; --text: #1e293b; --muted: #64748b; --border: #e2e8f0;
            --red: #ef4444; --green: #22c55e; --yellow: #eab308;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--text); }

        nav { background:var(--card); border-bottom:1px solid var(--border); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
        .logo { font-size:1.4rem; font-weight:700; color:var(--primary); }
        .logo span { color:var(--accent); }
        nav a { color:var(--muted); text-decoration:none; margin-left:1.5rem; font-size:.9rem; }

        .container { max-width:960px; margin:2rem auto; padding:0 1.5rem; }

        .disclaimer { background:#fef3c7; border-left:4px solid #f59e0b; padding:.75rem 1rem; border-radius:4px; font-size:.85rem; color:#92400e; margin-bottom:2rem; }

        .panel { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.5rem; margin-bottom:1.5rem; }
        .panel h2 { font-size:1.1rem; margin-bottom:1rem; }

        label { display:block; font-size:.85rem; font-weight:600; color:var(--muted); margin-bottom:.3rem; margin-top:.75rem; }
        select, input { width:100%; padding:.5rem .75rem; border:1px solid var(--border); border-radius:6px; font-size:.9rem; }
        .row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; }

        .checks { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.4rem; }
        .checks label { display:flex; align-items:center; gap:.35rem; font-weight:400; color:var(--text); cursor:pointer; font-size:.9rem; margin:0; }

        .btn { display:inline-block; padding:.65rem 1.5rem; border-radius:8px; font-size:1rem; font-weight:600; border:none; cursor:pointer; }
        .btn-primary { background:var(--primary); color:#fff; width:100%; margin-top:1.25rem; }
        .btn-primary:disabled { background:var(--muted); cursor:not-allowed; }

        /* Progress */
        .progress-wrap { display:none; }
        .progress-wrap.active { display:block; }
        .progress-bar-bg { background:var(--border); border-radius:8px; height:28px; overflow:hidden; position:relative; margin:.75rem 0; }
        .progress-bar { background:linear-gradient(90deg,var(--primary),var(--accent)); height:100%; border-radius:8px; transition:width .4s ease; }
        .progress-bar-bg .pct { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-size:.8rem; font-weight:700; color:var(--text); }
        .stage-label { font-size:.9rem; color:var(--muted); }
        .stages { display:flex; gap:.25rem; margin-top:.5rem; flex-wrap:wrap; }
        .stages .s { padding:.3rem .7rem; border-radius:6px; font-size:.78rem; font-weight:600; background:var(--border); color:var(--muted); }
        .stages .s.done { background:#dcfce7; color:#166534; }
        .stages .s.active { background:#dbeafe; color:var(--primary); }

        /* Results */
        #results { display:none; }
        #results.active { display:block; }
        .metric-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:.75rem; }
        .metric { background:var(--bg); border-radius:8px; padding:.85rem; text-align:center; }
        .metric .val { font-size:1.5rem; font-weight:700; color:var(--primary); }
        .metric .lbl { font-size:.75rem; color:var(--muted); margin-top:.2rem; }

        table { width:100%; border-collapse:collapse; font-size:.85rem; margin-top:1rem; }
        th { text-align:left; padding:.5rem; border-bottom:2px solid var(--border); color:var(--muted); font-size:.78rem; text-transform:uppercase; }
        td { padding:.5rem; border-bottom:1px solid var(--border); }
        tr.best { background:#f0fdf4; }

        .feat-list { list-style:none; margin-top:.5rem; }
        .feat-list li { display:flex; align-items:center; gap:.5rem; padding:.3rem 0; font-size:.9rem; }
        .feat-bar-bg { flex:1; background:var(--border); border-radius:4px; height:10px; }
        .feat-bar { background:var(--accent); height:100%; border-radius:4px; }

        .rec { padding:.5rem .75rem; border-radius:6px; margin-top:.5rem; font-size:.9rem; }
        .rec.HIGH { background:#fef2f2; border-left:3px solid var(--red); }
        .rec.MEDIUM { background:#fefce8; border-left:3px solid var(--yellow); }
        .rec.INFO { background:#eff6ff; border-left:3px solid var(--primary); }
        .rec .tag { font-size:.7rem; font-weight:700; margin-right:.4rem; }

        .error-box { background:#fef2f2; border:1px solid #fecaca; border-radius:8px; padding:1rem; color:#991b1b; font-size:.85rem; white-space:pre-wrap; display:none; }
        .error-box.active { display:block; }

        @media(max-width:640px){ .row{grid-template-columns:1fr;} .metric-grid{grid-template-columns:1fr 1fr;} }
    </style>
</head>
<body>

<nav>
    <div class="logo">Oncology<span>ML</span></div>
    <div><a href="/docs">API Docs</a></div>
</nav>

<div class="container">
    <div class="disclaimer">
        <strong>Research Use Only:</strong> This is a machine learning research tool. It does NOT provide medical diagnoses or treatment recommendations.
    </div>

    <!-- CONFIG PANEL -->
    <div class="panel" id="configPanel">
        <h2>Run Analysis</h2>
        <label>Dataset</label>
        <select id="dataset"></select>

        <label>Models</label>
        <div class="checks" id="modelChecks"></div>

        <div class="row">
            <div><label>Scaling</label><select id="scaling"><option value="standard">Standard</option><option value="minmax">MinMax</option></select></div>
            <div><label>Test Size</label><input id="testSize" type="number" value="0.2" min="0.05" max="0.5" step="0.05"></div>
            <div><label>CV Folds</label><input id="cvFolds" type="number" value="5" min="2" max="20"></div>
        </div>

        <button class="btn btn-primary" id="runBtn" onclick="startAnalysis()">Run Analysis</button>
    </div>

    <!-- PROGRESS PANEL -->
    <div class="panel progress-wrap" id="progressPanel">
        <h2>Analysis Progress</h2>
        <div class="progress-bar-bg"><div class="progress-bar" id="pBar" style="width:0%"></div><span class="pct" id="pPct">0%</span></div>
        <div class="stage-label" id="stageLabel">Waiting...</div>
        <div class="stages" id="stageChips"></div>
    </div>

    <!-- ERROR -->
    <div class="error-box" id="errorBox"></div>

    <!-- RESULTS -->
    <div id="results">
        <div class="panel">
            <h2>Best Model</h2>
            <div class="metric-grid" id="bestMetrics"></div>
        </div>
        <div class="panel">
            <h2>All Models</h2>
            <table><thead><tr><th>Model</th><th>Accuracy</th><th>Precision</th><th>Recall</th><th>F1</th><th>AUC</th><th>MCC</th></tr></thead><tbody id="modelTable"></tbody></table>
        </div>
        <div class="panel">
            <h2>Top Predictive Features</h2>
            <ul class="feat-list" id="featList"></ul>
        </div>
        <div class="panel">
            <h2>Recommendations</h2>
            <div id="recList"></div>
        </div>
    </div>
</div>

<script>
const ALL_STAGES = ["Data Loading","Exploratory Analysis","Preprocessing","Model Training","Evaluation","Report Generation"];

// Populate dropdowns on load
(async function init(){
    const ds = await(await fetch("/api/v1/datasets")).json();
    const sel = document.getElementById("dataset");
    for(const[k,v] of Object.entries(ds)){
        const o = document.createElement("option"); o.value=k; o.textContent=`${k} â€” ${v.description}`; sel.appendChild(o);
    }
    const models = await(await fetch("/api/v1/models")).json();
    const wrap = document.getElementById("modelChecks");
    for(const[k,v] of Object.entries(models)){
        const lbl = document.createElement("label");
        lbl.innerHTML = `<input type="checkbox" value="${k}" checked> ${k}`;
        wrap.appendChild(lbl);
    }
    // Stage chips
    const chips = document.getElementById("stageChips");
    ALL_STAGES.forEach(s => { const d=document.createElement("div"); d.className="s"; d.textContent=s; chips.appendChild(d); });
})();

let pollTimer = null;

async function startAnalysis(){
    const btn = document.getElementById("runBtn");
    btn.disabled = true; btn.textContent = "Running...";
    document.getElementById("results").classList.remove("active");
    document.getElementById("errorBox").classList.remove("active");
    document.getElementById("progressPanel").classList.add("active");
    resetProgress();

    const checked = [...document.querySelectorAll("#modelChecks input:checked")].map(c=>c.value);
    const body = {
        dataset: document.getElementById("dataset").value,
        models: checked.length ? checked : null,
        scaling: document.getElementById("scaling").value,
        test_size: parseFloat(document.getElementById("testSize").value),
        cv_folds: parseInt(document.getElementById("cvFolds").value),
    };

    const res = await fetch("/api/v1/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
    const data = await res.json();
    if(!res.ok){ showError(data.detail||"Submit failed"); btn.disabled=false; btn.textContent="Run Analysis"; return; }

    pollTimer = setInterval(()=>pollJob(data.job_id), 1000);
}

async function pollJob(jobId){
    const res = await fetch(`/api/v1/jobs/${jobId}`);
    const job = await res.json();

    // Update progress
    const pct = job.progress_pct || 0;
    document.getElementById("pBar").style.width = pct+"%";
    document.getElementById("pPct").textContent = pct+"%";
    document.getElementById("stageLabel").textContent = job.stage ? `Stage ${job.stage_number}/${job.total_stages}: ${job.stage}` : "Starting...";

    // Update chips
    const chips = document.querySelectorAll("#stageChips .s");
    chips.forEach((c,i) => {
        c.className = "s";
        if(job.stage_number && i < job.stage_number - 1) c.classList.add("done");
        else if(job.stage_number && i === job.stage_number - 1) c.classList.add("active");
    });

    if(job.status === "completed"){
        clearInterval(pollTimer);
        // Mark all chips done
        chips.forEach(c => { c.className = "s done"; });
        document.getElementById("pBar").style.width = "100%";
        document.getElementById("pPct").textContent = "100%";
        document.getElementById("stageLabel").textContent = "Complete!";
        showResults(job.report);
        document.getElementById("runBtn").disabled = false;
        document.getElementById("runBtn").textContent = "Run Analysis";
    }
    if(job.status === "failed"){
        clearInterval(pollTimer);
        showError(job.error || "Unknown error");
        document.getElementById("runBtn").disabled = false;
        document.getElementById("runBtn").textContent = "Run Analysis";
    }
}

function resetProgress(){
    document.getElementById("pBar").style.width = "0%";
    document.getElementById("pPct").textContent = "0%";
    document.getElementById("stageLabel").textContent = "Starting...";
    document.querySelectorAll("#stageChips .s").forEach(c=>c.className="s");
}

function showError(msg){
    const box = document.getElementById("errorBox");
    box.textContent = msg; box.classList.add("active");
}

function showResults(report){
    document.getElementById("results").classList.add("active");

    // Best model metrics
    const best = report.evaluation.best_metrics;
    const bestName = report.evaluation.best_model;
    const mg = document.getElementById("bestMetrics");
    mg.innerHTML = "";
    const metrics = [
        ["Model", bestName], ["Accuracy", best.accuracy], ["F1", best.f1],
        ["AUC", best.roc_auc||"N/A"], ["MCC", best.mcc], ["Precision", best.precision],
        ["Recall", best.recall]
    ];
    metrics.forEach(([lbl,val])=>{
        const d = document.createElement("div"); d.className="metric";
        d.innerHTML = `<div class="val">${typeof val==="number"?val.toFixed(4):val}</div><div class="lbl">${lbl}</div>`;
        mg.appendChild(d);
    });

    // Model comparison table
    const tb = document.getElementById("modelTable"); tb.innerHTML = "";
    for(const[name,m] of Object.entries(report.evaluation.all_models)){
        const tr = document.createElement("tr");
        if(name === bestName) tr.className = "best";
        tr.innerHTML = `<td><strong>${name}</strong></td><td>${m.accuracy}</td><td>${m.precision}</td><td>${m.recall}</td><td>${m.f1}</td><td>${m.roc_auc||"N/A"}</td><td>${m.mcc}</td>`;
        tb.appendChild(tr);
    }

    // Feature importance
    const fl = document.getElementById("featList"); fl.innerHTML = "";
    const feats = (report.feature_importance||[]).slice(0,10);
    const maxImp = feats.length ? feats[0].importance : 1;
    feats.forEach((f,i)=>{
        const li = document.createElement("li");
        const w = Math.max(5, (f.importance/maxImp)*100);
        li.innerHTML = `<span style="min-width:180px">${i+1}. ${f.feature}</span><div class="feat-bar-bg"><div class="feat-bar" style="width:${w}%"></div></div><span style="min-width:60px;text-align:right;font-size:.8rem;color:var(--muted)">${f.importance.toFixed(4)}</span>`;
        fl.appendChild(li);
    });

    // Recommendations
    const rl = document.getElementById("recList"); rl.innerHTML = "";
    (report.recommendations||[]).forEach(r=>{
        const d = document.createElement("div"); d.className = `rec ${r.priority}`;
        d.innerHTML = `<span class="tag">${r.priority}</span>${r.recommendation}`;
        rl.appendChild(d);
    });
}
</script>
</body>
</html>
